const fs = require("fs");
const path = require("path");
const { chain } = require("stream-chain");
const { parser } = require("stream-json");
const { streamArray } = require("stream-json/streamers/StreamArray");

const INPUT = "input.json";
const OUTPUT_DIR = "mongo_output";
const RECORDS_PER_FILE = 1000;
const COLLECTION = "myDB";

// create folder if missing
if (!fs.existsSync(OUTPUT_DIR)) {
  fs.mkdirSync(OUTPUT_DIR);
}

let totalRecords = 0;
let fileIndex = 1;
let recordInFile = 0;
let fileTotal = 0;

let writer = createNewFile(fileIndex);

console.log("ðŸš€ Generating Mongo insert JS files...");

function createNewFile(index) {
  const filePath = path.join(OUTPUT_DIR, `out${index}.js`);
  const stream = fs.createWriteStream(filePath);

  // header
  stream.write(`async function insertDocument(db) {\n\n`);
  stream.write(`await db.collection('${COLLECTION}').deleteMany({});\n\n`);

  recordInFile = 0;
  fileTotal = 0;

  return stream;
}

function closeFile() {
  writer.write(`\n}\n\nmodule.exports = insertDocument;\n`);
  writer.end();

  console.log(
    `âœ… out${fileIndex}.js â†’ inserted ${fileTotal} records`
  );
}

const pipeline = chain([
  fs.createReadStream(INPUT),
  parser(),
  streamArray()
]);

pipeline.on("data", ({ value }) => {
  const json = JSON.stringify(value, null, 2);

  if (recordInFile === RECORDS_PER_FILE - 1) {
    writer.write(
      `return await db.collection('${COLLECTION}').insertOne(${json});\n`
    );
  } else {
    writer.write(
      `await db.collection('${COLLECTION}').insertOne(${json});\n\n`
    );
  }

  recordInFile++;
  fileTotal++;
  totalRecords++;

  if (recordInFile === RECORDS_PER_FILE) {
    closeFile();
    fileIndex++;
    writer = createNewFile(fileIndex);
  }
});

pipeline.on("end", () => {
  if (recordInFile > 0) closeFile();

  console.log("\nðŸŽ‰ Completed!");
  console.log("Total records processed:", totalRecords);
  console.log(`ðŸ“‚ Files saved in folder: ${OUTPUT_DIR}`);
});
