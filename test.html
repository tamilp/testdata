const fs = require("fs");
const { chain } = require("stream-chain");
const { parser } = require("stream-json");
const { streamArray } = require("stream-json/streamers/StreamArray");

const INPUT = "input.json";
const NUM_FILES = 4;

// writers + counters
const writers = [];
const counts = Array(NUM_FILES).fill(0);
let totalRecords = 0;

// create output files
for (let i = 0; i < NUM_FILES; i++) {
  const stream = fs.createWriteStream(`out${i + 1}.json`);
  stream.write("[\n");
  writers.push(stream);
}

console.log("ðŸš€ Starting split...");

const pipeline = chain([
  fs.createReadStream(INPUT),
  parser(),
  streamArray()
]);

pipeline.on("data", ({ value }) => {
  const fileIndex = totalRecords % NUM_FILES; // round-robin

  const writer = writers[fileIndex];

  if (counts[fileIndex] > 0) writer.write(",\n");

  writer.write(JSON.stringify(value));

  counts[fileIndex]++;
  totalRecords++;
});

pipeline.on("end", () => {
  writers.forEach(w => w.write("\n]"));
  writers.forEach(w => w.end());

  console.log("\nâœ… Split completed!");
  console.log("Total records processed:", totalRecords);

  console.log("\nðŸ“¦ Records per file:");
  counts.forEach((count, i) => {
    console.log(`out${i + 1}.json â†’ ${count}`);
  });
});
