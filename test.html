const fs = require("fs");
const { chain } = require("stream-chain");
const { parser } = require("stream-json");
const { streamArray } = require("stream-json/streamers/StreamArray");

const INPUT_FILE = "input.json";
const NUM_FILES = 3;

let totalCount = 0;
let buffers = Array.from({ length: NUM_FILES }, () => []);

// First pass → count items
const countPipeline = chain([
  fs.createReadStream(INPUT_FILE),
  parser(),
  streamArray()
]);

countPipeline.on("data", () => totalCount++);
countPipeline.on("end", () => {
  const perFile = Math.ceil(totalCount / NUM_FILES);

  console.log("Total records:", totalCount);
  console.log("Records per file:", perFile);

  let index = 0;

  const splitPipeline = chain([
    fs.createReadStream(INPUT_FILE),
    parser(),
    streamArray()
  ]);

  splitPipeline.on("data", ({ value }) => {
    const fileIndex = Math.floor(index / perFile);
    buffers[fileIndex].push(value);
    index++;
  });

  splitPipeline.on("end", () => {
    buffers.forEach((data, i) => {
      fs.writeFileSync(
        `output_${i + 1}.json`,
        JSON.stringify(data, null, 2)
      );
      console.log(`Created output_${i + 1}.json`);
    });

    console.log("✅ Split complete");
  });
});
