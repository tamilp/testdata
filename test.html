import { ComponentFixture, TestBed } from '@angular/core/testing';
import { NgZone } from '@angular/core';
import { YourComponent } from './your.component';
import { of } from 'rxjs';

describe('YourComponent', () => {
  let component: YourComponent;
  let fixture: ComponentFixture<YourComponent>;
  let mockFdc3Client: any;
  let mockChangeBorderRadius: jasmine.Spy;

  beforeEach(() => {
    mockFdc3Client = {
      addIntentListener: jasmine.createSpy('addIntentListener')
    };

    TestBed.configureTestingModule({
      declarations: [YourComponent],
      providers: [
        NgZone,
        { provide: 'fdc3Client', useValue: mockFdc3Client }
      ]
    });

    fixture = TestBed.createComponent(YourComponent);
    component = fixture.componentInstance;
    mockChangeBorderRadius = spyOn(component, 'changeBorderRadius');
  });

  it('should add pega-chat-center class and call changeBorderRadius when payload type matches', () => {
    // Capture the FDC3 listener callback
    let listenerCallback: any;
    mockFdc3Client.addIntentListener.and.callFake((intent, cb) => {
      listenerCallback = cb;
    });

    // Run the code that registers the listener
    component.ngOnInit?.();

    // Mock DOM structure with nested shadowRoots
    const chatIconEl = document.createElement('div');
    chatIconEl.classList.add('pega-chat-icon');

    const shadowRoot2: any = { querySelector: () => chatIconEl };
    const shadowRoot1: any = { shadowRoot: shadowRoot2 };

    spyOn(document, 'getElementById').and.returnValue(shadowRoot1);

    // Trigger the listener callback with matching payload
    listenerCallback({ type: 'FDC3_EPF_MENU_ACTION' });

    // Verify expectations
    expect(chatIconEl.classList.contains('pega-chat-center')).toBeTrue();
    expect(mockChangeBorderRadius).toHaveBeenCalled();
  });
});
