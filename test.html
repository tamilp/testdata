import {
  HttpEvent,
  HttpInterceptorFn,
  HttpRequest,
  HttpHandlerFn,
  HttpEventType
} from '@angular/common/http';
import { tap } from 'rxjs';

function formatWallClock(msEpoch: number) {
  const d = new Date(msEpoch);
  return d.toISOString().split('T')[1].replace('Z', '');
}

function formatMs(v: number) {
  return `${v.toFixed(3)} ms`;
}

function logRequestResponsePhases(reqUrl: string) {
  setTimeout(() => {
    const entries = performance.getEntriesByType("resource") as PerformanceResourceTiming[];
    const target = new URL(reqUrl, location.href).href;

    const entry = entries.reverse().find(e => e.name === target || e.name.includes(reqUrl));
    if (!entry) {
      console.warn(`No performance entry found for ${reqUrl}`);
      return;
    }

    // NavigationStart reference point
    const navStart = Date.now() - performance.now();
    const abs = (t: number) => navStart + t;

    const requestStart = abs(entry.requestStart);
    const requestEnd   = abs(entry.responseStart); // request ends when waiting starts
    const responseStart= abs(entry.responseStart);
    const responseEnd  = abs(entry.responseEnd);

    console.log(`ðŸ“¡ Network timeline for ${reqUrl}`);
    console.log(`  Request Start : ${formatWallClock(requestStart)} (+${formatMs(entry.requestStart - entry.startTime)})`);
    console.log(`  Request End   : ${formatWallClock(requestEnd)}`);
    console.log(`  Response Start: ${formatWallClock(responseStart)}`);
    console.log(`  Response End  : ${formatWallClock(responseEnd)}`);
    console.log(`  Total Duration: ${formatMs(entry.responseEnd - entry.startTime)}`);
  }, 50);
}

export const detailedLoggingInterceptor: HttpInterceptorFn =
  (req: HttpRequest<unknown>, next: HttpHandlerFn) => {
    const started = performance.now();
    const formatElapsed = () => `${(performance.now() - started).toFixed(3)} ms`;
    const now = () => new Date().toISOString().split('T')[1].replace('Z', '');
    const prefix = () => `[${now()} | +${formatElapsed()}]`;

    console.log(`${prefix()} [REQUEST START] ${req.method} ${req.urlWithParams}`);

    return next(req).pipe(
      tap({
        next: (event: HttpEvent<unknown>) => {
          if (event.type === HttpEventType.Response) {
            console.log(`${prefix()} [RESPONSE END] ${req.method} ${req.urlWithParams}`);
            logRequestResponsePhases(req.urlWithParams);
          }
        },
        error: (error) => {
          console.error(`${prefix()} [RESPONSE ERROR] ${req.method} ${req.urlWithParams}`, error);
          logRequestResponsePhases(req.urlWithParams);
        }
      })
    );
  };
