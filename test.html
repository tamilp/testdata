// pdf-with-font.component.ts
import { Component } from '@angular/core';
import jsPDF from 'jspdf';

@Component({
  selector: 'app-pdf-with-font',
  template: `
    <button (click)="generatePdf()">Download PDF (embedded font)</button>
  `
})
export class PdfWithFontComponent {

  async generatePdf() {
    // 1) load font from assets and convert to base64
    const fontUrl = 'assets/fonts/NotoSansSC-Regular.ttf';
    const base64 = await this.loadFontAsBase64(fontUrl);

    // 2) register font with jsPDF
    // addFileToVFS and addFont are available on jsPDF.API
    (jsPDF as any).API.addFileToVFS('NotoSansSC-Regular.ttf', base64);
    (jsPDF as any).API.addFont('NotoSansSC-Regular.ttf', 'NotoSansSC', 'normal');

    // 3) create pdf, set font and write Chinese text
    const doc = new jsPDF({ unit: 'mm', format: 'a4' });
    doc.setFont('NotoSansSC', 'normal'); // use registered font
    doc.setFontSize(16);

    const text = '你好，世界！ — Selectable and searchable text in the PDF.';
    doc.text(text, 20, 30);
    doc.save('document-with-font.pdf');
  }

  private async loadFontAsBase64(url: string): Promise<string> {
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();
    let binary = '';
    const bytes = new Uint8Array(arrayBuffer);
    const chunkSize = 0x8000; // avoid stack overflow on very large fonts
    for (let i = 0; i < bytes.length; i += chunkSize) {
      const chunk = bytes.subarray(i, i + chunkSize);
      binary += String.fromCharCode.apply(null, Array.from(chunk));
    }
    return btoa(binary);
  }
}
