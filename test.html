const fs = require("fs");
const { chain } = require("stream-chain");
const { parser } = require("stream-json");
const { streamArray } = require("stream-json/streamers/StreamArray");

const INPUT = "input.json";
const NUM_FILES = 4;

const writers = [];
const counts = Array(NUM_FILES).fill(0);

// create output streams
for (let i = 0; i < NUM_FILES; i++) {
  const stream = fs.createWriteStream(`output_${i + 1}.json`);
  stream.write("[\n");
  writers.push(stream);
}

let index = 0;

const pipeline = chain([
  fs.createReadStream(INPUT),
  parser(),
  streamArray()
]);

pipeline.on("data", ({ value }) => {
  const fileIndex = index % NUM_FILES; // round-robin distribution

  const writer = writers[fileIndex];

  if (counts[fileIndex] > 0) writer.write(",\n");

  writer.write(JSON.stringify(value));

  counts[fileIndex]++;
  index++;
});

pipeline.on("end", () => {
  writers.forEach(w => w.write("\n]"));
  writers.forEach(w => w.end());

  console.log("âœ… Split complete without memory crash");
});
